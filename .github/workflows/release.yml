name: Publish Helm Repo

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
      - master
    paths:
      - 'packages/**'
      - '.github/workflows/release.yml'
    tags-ignore:
      - '**'

permissions:
  contents: write

jobs:
  publish:
    name: Publish .tgz and index.yaml to Pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout gh-pages (if exists)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
          fetch-depth: 0
        continue-on-error: true

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Prepare dist and copy existing
        run: |
          mkdir -p dist
          if [ -d gh-pages ]; then
            cp -R gh-pages/* dist/ 2>/dev/null || true
          fi

      - name: Copy packages/*.tgz into dist
        run: |
          shopt -s nullglob || true
          mkdir -p packages
          cp packages/*.tgz dist/ 2>/dev/null || true

      - name: Seed example chart if empty
        run: |
          if [ -z "$(ls -1 dist/*.tgz 2>/dev/null)" ]; then
            echo "No packages found; seeding example chart..."
            helm create example >/dev/null 2>&1 || helm create example
            # remove extras to keep it small
            rm -rf example/templates/tests
            helm package example -d dist
            rm -rf example
          else
            echo "Packages detected; skipping seed."
          fi

      - name: Generate index.yaml
        run: |
          helm repo index dist --url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"

      - name: Publish to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: dist
          publish_branch: gh-pages
